# -*- coding: utf-8 -*-
from __future__ import unicode_literals

import datetime

from django.db import migrations, models
from django.db.models import Q


def forwards_func(apps, schema_editor):
    # We get the model from the versioned app registry;
    # if we directly import it, it'll be the wrong version
    Persona = apps.get_model("anagrafica", "Persona")
    Sede = apps.get_model("anagrafica", "Sede")
    Delega = apps.get_model("anagrafica", "Delega")
    db_alias = schema_editor.connection.alias

    # Questa migrazione ripristina tutte le deleghe
    # di ufficio soci che, alla data della migrazione,
    # erano assegnate a una unita' territoriale, modificandole
    # e ripristinandole come UFFICIO_SOCI_UNITA piuttosto che UFFICIO_SOCI.

    # coppie (id_persona, id_comitato)
    coppie = [(2861,57,148),(2884,57,148),(2801,57,148),(411,48,146),(907,48,146),(411,49,146),(1214,50,147),(1650,85,155),(1236,50,147),(746,50,147),(1019,50,147),(907,49,146),(411,49,146),(1403,96,158),(1897,90,156),(191,23,5),(907,49,146),(411,48,146),(1597,103,162),(1345,57,148),(2120,105,164),(1987,107,166),(2071,102,161),(1826,102,161),(2072,102,161),(1658,48,146),(2152,106,165),(642,42,9),(2263,107,166),(2200,97,159),(1980,97,159),(2221,98,159),(2221,98,159),(1980,98,159),(2200,98,159),(1980,99,159),(2200,99,159),(2200,100,159),(2430,100,159),(1980,100,159),(2408,107,166),(2523,95,157),(2488,95,157),(2519,95,157),(2913,108,167),(413,29,6),(422,28,5),(2951,109,168),(302,45,143),(2978,112,170),(2827,57,148),(2256,168,102480),(689,45,143),(751,199,1709),(3639,199,1709),(783,49,146),(783,48,146),(783,49,146),(366,199,1709),(366,200,1709),(366,201,1709),(3613,103,162),(3765,208,3670),(4575,199,1709),(783,48,146),(4575,200,1709),(4866,283,27899),(3865,145,197),(3937,145,197),(4414,114,172),(3703,249,18862),(4661,161,210),(15748,52,147),(333,31,6),(3891,346,28718),(3879,346,28718),(5470,376,28723),(3934,192,1511),(3800,192,1511),(6004,407,40819),(6618,422,46936),(3596,422,46936),(4527,160,208),(5626,209,3670),(1406,211,3670),(5572,211,3670),(7494,641,188),(7718,131,188),(5217,131,188),(3891,344,28718),(8109,641,188),(6807,181,1499),(8285,231,18146),(9094,2527,102232),(9118,2526,102232),(9214,2526,102232),(8044,108,167),(7997,108,167),(9537,237,18556),(8157,1191,102196),(7186,107,166),(10009,2528,102232),(10037,354,28719),(9510,231,18146),(10316,2573,102250),(10714,2562,102244),(10316,2575,102250),(10362,2575,102250),(10316,2574,102250),(10362,2574,102250),(10362,2573,102250),(4023,151,202),(6051,157,202),(11674,1194,102197),(11578,1194,102197),(10172,273,200),(5502,273,200),(11421,273,200),(5502,273,200),(10172,148,200),(11421,148,200),(5502,148,200),(10172,149,200),(11421,149,200),(5502,149,200),(12003,2812,102384),(6606,494,65143),(6606,493,65143),(13548,2815,102387),(12316,2815,102387),(12572,364,28720),(2719,107,166),(3971,136,193),(14671,124,181),(5720,107,166),(8342,233,18149),(3737,170,781),(13418,2883,102408),(15945,2978,102446),(16063,1390,102198),(16071,1390,102198),(13418,2895,102408),(15858,2975,102443),(16142,2975,102443),(474,3,1),(15311,2777,102357),(18030,2778,102357),(14806,2842,102395),(18986,2842,102395),(11987,2842,102395),(19251,2782,102359),(9441,285,27906),(19424,2596,102259),(20011,2597,102259),(2332,107,166),(5040,3069,102462),(20910,3105,102471),(6928,3076,102466),(10528,2574,102250),(10351,2574,102250),(10348,2575,102250),(1642,85,155),(1663,85,155),(10378,2575,102250),(10378,2574,102250),(10378,2573,102250),(6606,3108,65143),(22713,2886,102411),(1833,49,146),(1833,48,146),(3870,257,24478),(3870,268,24478),(13828,216,8406),(7111,423,46937),(7111,424,46937),(6976,423,46937),(3870,260,24478),(3870,258,24478),(9641,2526,102232),(9132,2526,102232),(2996,170,781),(21585,2712,102316),(22355,2687,102302),(3050,2856,102396),(29879,2605,102492),(17565,421,46935),(3870,262,24478),(787,49,146),(6278,547,102190),(3870,259,24478),(2315,109,168),(3270,109,168),(6732,547,102190),(2256,162,102479),(3271,109,168),(3707,199,1709),(3657,200,1709),(10328,2573,102250),(10481,2573,102250),(4665,152,202),(6050,154,202),(248,22,5),(305,27,5),(544,26,5),(353,25,5),(36235,2584,102255),(36574,2583,102255),(36855,2583,102255),(36855,2584,102255),(10719,3157,102503),(29268,3157,102503),(10719,3151,102503),(1364,58,149),(28955,58,149),(2969,216,8406),(2970,216,8406),(3590,109,168),(9477,2567,102247),(10037,355,28719),(10037,358,28719),(10037,357,28719),(10037,356,28719),(10037,359,28719),(10037,360,28719),(33618,165,102482),(33618,166,102482),(3033,29,6),(3865,145,197),(30216,2162,102215),(29097,3188,102522),(36958,3188,102522),(39121,3176,102516),(366,3189,1709),(1531,2764,102349),(38468,2764,102349),(460,30,6),(3033,31,6),(24517,95,157),(22966,443,53668),(7970,108,167),(22966,444,53668),(14830,2528,102232),(1406,210,3670),(33285,3176,102516),(36574,2584,102255),(47409,2168,102221),(37352,3173,102511),(49388,2996,102452),(6447,140,102546),(40664,167,102483),(2500,95,157),(22396,85,155),(1663,87,155),(22396,87,155),(22396,86,155),(1663,86,155),(22396,89,155),(1663,89,155),(46689,602,102192),(46661,602,102192),(33049,598,102192),(4735,275,27044),(53239,431,46940),(53300,432,46940),(53511,434,46940),(54248,24,5),(785,42,9),(365,31,6),(46607,601,102192),(9503,601,102192),(37178,603,102192),(27047,603,102192),(46629,600,102192),(25214,3088,102467),(55415,433,46940),(191,23,5),(248,22,5),(353,25,5),(305,27,5),(9098,3255,102555),(30956,3080,102467),(4953,257,24478),(3865,145,197),(22591,2623,102268),(5095,120,177),(12581,120,177),(47344,2903,102423),(56028,2904,102423),(50738,2904,102423),(59430,2901,102421),(13494,3246,102553),(4735,274,27044),(7221,224,202),(4547,158,202),(4552,158,202),(5279,155,202),(3771,208,3670),(5962,209,3670),(15419,211,3670),(7623,211,3670),(4901,429,46940),(4852,300,28212),(4901,431,46940),(4901,432,46940),(4901,433,46940),(4901,434,46940),(1531,2765,102349),(49108,2976,102444),(413,30,6),(413,31,6),(7611,604,102192),(9441,286,27906),(2529,95,157),(38175,2884,102409),(37150,2884,102409),(3096,116,174),(22224,3187,102521),(13748,2903,102423),(68525,2903,102423),(2500,95,157),(13991,2822,102387),(13991,2816,102387),(13991,2817,102387),(13991,2818,102387),(13991,2825,102387),(39376,3052,102460),(20408,3046,102460),(9372,3038,102460),(28966,3039,102460),(9230,3059,102460),(56885,3050,102460),(56585,3054,102460),(50595,3051,102460),(56760,3057,102460),(21045,3041,102460),(70006,3023,102459),(15776,431,46940),(15776,429,46940),(55417,429,46940),(15776,432,46940),(15776,433,46940),(15776,434,46940),(53518,434,46940),(54149,3249,102553),(14913,3239,102553),(62358,3248,102553),(68855,3242,102553),(62546,3247,102553),(57668,3251,102553),(30770,3090,102467),(30675,3094,102467),(31462,3096,102467),(31300,3084,102467),(31234,3084,102467),(30471,3082,102467),(30578,3082,102467),(21790,3093,102467),(32157,3093,102467),(32098,3093,102467),(31504,3087,102467),(31453,3087,102467),(30837,3078,102467),(30342,3086,102467),(25103,421,46935),(21133,3246,102553),(31148,3077,102467),(13500,2874,102400),(53300,432,46940),(5654,273,200),(5654,148,200),(5654,149,200),(18965,2801,102377),(72092,2768,102351),(75203,2874,102400),(58491,3220,102543),(9973,2527,102232),(48376,2878,102403),(77047,2878,102403),(33336,162,102479),(34192,249,18862),(67389,249,18862),(22466,3105,102471),(75203,2875,102400),(3880,256,20053),(55936,256,20053),(32305,1391,102198),(53394,433,46940),(15063,2550,102239),(37550,2550,102239),(33688,2550,102239),(1954,96,158),(1857,96,158),(1861,96,158),(2963,85,155),(31988,134,191),(51283,3257,102556),(81893,3256,102556),(81893,3261,102556),(2342,107,166),(1653,89,155),(1653,85,155),(10063,2914,102425),(10434,2575,102250),(10434,2574,102250),(10434,2573,102250),(1589,58,149),(40687,277,27044),(40812,277,27044),(15495,107,166),(3532,107,166),(24327,107,166),(16496,394,31516),(13991,2819,102387),(13991,2821,102387),(13991,2820,102387),(13991,2823,102387),(13991,2826,102387),(13991,2827,102387),(13991,2828,102387),(13991,2829,102387),(13991,2824,102387),(1838,3318,6),(10439,2575,102250),(19911,205,2444),(15445,205,2444),(44639,2757,102345),(639,42,9),(33057,2741,102340),(19720,358,28719),(92244,2976,102444),(64047,279,27044),(5341,3320,202),(88836,3192,102529),(87549,3349,102588),(24337,281,27199),(94187,2751,102342),(94192,2751,102342),(2958,3112,102474),(94729,3112,102474),(89718,2903,102423),(41116,3006,102454),(46561,140,102546),(93182,143,102546),(25165,141,102546),(94271,2751,102342),(94835,2751,102342),(24511,131,188),(95364,2751,102342),(9983,342,28703),(94740,342,28703),(68942,2686,102301),(53394,429,46940),(96827,2698,102310),(96827,2699,102310),(96827,2700,102310),(2041,24,5),(93080,2978,102446),(92918,2978,102446),(99428,2741,102340),(99816,340,28703),(6362,338,28703),(96350,341,28703),(94740,336,28703),(16096,342,28703),(30730,3092,102467),(7633,389,31516),(87241,393,31516),(98023,2723,102325),(13393,3238,102552),(79734,3264,102558),(9767,2734,102334),(9767,2733,102334),(70990,2734,102334),(99373,2803,102379),(94192,2751,102342),(3657,200,1709),(12498,2716,102320),(11177,2716,102320),(39308,275,27044),(36937,275,27044),(639,3370,9),(785,3370,9),(639,3369,9),(785,3369,9),(100787,2172,102223),(100782,2172,102223),(94457,3189,1709),(3840,133,190),(33726,2783,102360),(100992,2724,102326),(100992,3071,102326),(4735,274,27044),(97436,3325,27044),(61850,278,27044),(54672,107,166),(61076,2177,102225),(104935,3113,102475),(3595,361,28720),(3595,368,28720),(35141,165,102482),(35141,166,102482),(3033,3318,6),(32387,2845,102396),(104212,2845,102396),(101904,2845,102396),(9150,2526,102232),(100729,2698,102310),(103500,2699,102310),(18089,354,28719),(11775,1194,102197),(2493,95,157),(14630,54,147),(1110,55,147),(1077,55,147),(1045,55,147),(10222,2113,102206),(9328,2815,102387),(24444,2815,102387),(19433,2815,102387),(108933,2699,102310),(719,45,143),(77719,52,147),(83486,52,147),(31279,3077,102467),(96031,2173,102223),(102958,2171,102223),(18849,7,2),(14883,8,2),(37386,5,2),(8580,5,2),(30096,3081,102467),(66357,281,27199),(18343,368,28720),(20112,368,28720),(16895,362,28720),(17016,365,28720),(17244,366,28720),(17244,367,28720),(17275,367,28720),(18535,369,28720),(83724,370,28720),(5367,10,3),(112481,366,28720),(3033,30,6),(84118,370,28720),(18540,369,28720),(17077,365,28720),(12344,364,28720),(3595,368,28720),(289,116,174),(47421,2169,102222),(112772,366,28720),(113692,24,5),(10150,2698,102310),(93673,3316,102582),(92918,2979,102446),(93673,3317,102582),(72003,3077,102467),(113783,3077,102467),(90436,3317,102582),(90436,3316,102582),(21452,2687,102302),(22396,3322,155),(94835,2754,102342),(94192,2754,102342),(94187,2754,102342),(94192,2753,102342),(94835,2753,102342),(94187,2753,102342),(94835,2752,102342),(94192,2752,102342),(94187,2752,102342),(3004,2935,102436),(94271,2752,102342),(95364,2752,102342),(95364,2753,102342),(94271,2753,102342),(94271,2754,102342),(95364,2754,102342),(30235,3089,102467),(110445,3089,102467),(96675,2726,102327),(107727,2734,102334),(27021,3088,102467),(28823,2687,102302),(35945,96,158),(85351,2783,102360),(85449,2783,102360),(66360,32,7),(197,25,5),(16892,362,28720),(85077,429,46940),(85077,431,46940),(85077,432,46940),(85077,434,46940),(14754,3059,102460),(86134,2733,102334),(15729,2815,102387),(15729,2816,102387),(15729,2817,102387),(15729,2818,102387),(15729,2819,102387),(15729,2821,102387),(15729,2820,102387),(15729,2822,102387),(15729,2823,102387),(15729,2824,102387),(15729,2825,102387),(15729,2826,102387),(15729,2828,102387),(15729,2829,102387),(69926,2734,102334),(62392,276,27044),(118481,2683,102298),(21452,2688,102302),(22355,2688,102302),(34712,48,146),(5950,48,146),(13452,2892,102417),(95320,2878,102403),(55600,276,27044),(97440,3325,27044),(45697,3155,102503),(5367,10,3),(2919,12,3),(48769,46,144),(6216,46,144),(9265,3023,102459),(51302,3397,144),(11943,3397,144),(127641,2964,102438),(54102,26,5),(97040,2719,102322),(45701,3188,102522),(65821,3402,7),(66360,32,7),(66360,3408,7),(95035,2655,102281),(134334,3389,102609),(71364,3389,102609),(134440,3389,102609),(93147,3389,102609),(10219,3389,102609),(533,6,102485),(67067,56,3),(13948,2825,102387),(102118,2823,102387),(17313,2969,102441),(136118,2821,102387),(15311,2778,102357),(119359,2683,102298),(77157,2683,102298),(118073,2683,102298),(86376,2828,102387),(63626,2829,102387),(127229,2820,102387),(15779,3253,102553),(22305,2944,102436),(127660,2949,102436),(38116,2950,102436),(4882,2954,102436),(16300,2943,102436),(19204,2947,102436),(77066,3245,102553),(119781,2939,102436),(19205,2935,102436),(7565,2933,102435),(19245,2933,102435),(6218,116,174),(6218,117,174),(13106,2817,102387),(39828,274,27044),(14761,2777,102357),(20374,2777,102357),(14761,2778,102357),(3005,76,152),(3005,74,152),(3005,75,152),(3005,3420,152),(3005,3419,152),(6252,423,46937),(138590,2797,102373),(15343,2797,102373),(59069,3252,102553),(333,3318,6),(3005,76,152),(21534,76,152),(30165,3085,102467),(88786,3085,102467),(32586,3146,102502),(32347,3147,102502),(90195,3399,102612),(28812,200,1709),(34712,49,146),(44659,49,146),(44659,48,146),(131587,2709,102314),(299,2709,102314),(299,2710,102314),(131587,2710,102314),(10343,2573,102250),(31134,3091,102467),(29878,3098,102469),(40400,145,197),(32840,3147,102502),(90861,2768,102351),(10343,2575,102250),(13259,2518,102229),(13259,2520,102229),(13259,2519,102229),(16360,2931,102434),(130637,2824,102387),(6967,115,173),(12400,115,173),(2983,173,1003),(139388,173,1003),(83817,2597,102259),(106788,2597,102259),(111903,2720,102323),(13259,2521,102229),(136711,2720,102323),(26089,3088,102467),(30510,3088,102467),(17349,2883,102408),(2041,24,5),(137065,3417,102619),(45566,274,27044),(4043,145,197),(134453,3389,102609),(67369,336,28703),(96997,336,28703),(94206,336,28703),(96791,336,28703),(166539,2824,102387),(136186,3390,102609),(137347,3390,102609),(166066,3393,102609),(134725,3393,102609),(83745,3296,102574),(134334,3390,102609),(134440,3390,102609),(71364,3390,102609),(134334,3393,102609),(134440,3393,102609),(71364,3393,102609),(134334,3392,102609),(134440,3392,102609),(71364,3392,102609),(134334,3391,102609),(134440,3391,102609),(71364,3391,102609),(134436,3389,102609),(109677,3417,102619),(137063,3417,102619),(83745,3330,102574),(83745,3329,102574),(83745,3333,102574),(83745,3335,102574),(83745,3326,102574),(83745,3304,102574),(83745,3298,102574),(83745,3327,102574),(83745,3302,102574),(83745,3297,102574),(83745,3334,102574),(83745,3328,102574),(83745,3300,102574),(83745,3331,102574),(83745,3299,102574),(83745,3332,102574),(83745,3303,102574),(36304,2584,102255),(75996,2768,102351),(112850,3329,102574),(112850,3333,102574),(112850,3335,102574),(112850,3330,102574),(112850,3326,102574),(118345,2737,102336),(22296,2618,102266),(162812,2859,102396),(161763,2844,102396),(161928,2846,102396),(162008,2848,102396),(20290,2849,102396),(162163,2850,102396),(114804,2851,102396),(162203,2852,102396),(162237,2854,102396),(162407,2855,102396),(162643,2857,102396),(162726,2858,102396),(168708,140,102546),(171978,143,102546),(166451,141,102546),(10339,2575,102250),(62290,2719,102322),(4575,201,1709),(4575,3189,1709),(125976,2744,102340),(104056,2745,102340),(110613,2746,102340),(89909,2748,102340),(168983,2747,102340),(168878,2743,102340),(162207,2852,102396),(162531,2856,102396),(22467,2859,102396),(162653,2857,102396),(174005,3390,102609),(3729,200,1709),(139526,2845,102396),(176107,2729,102330),(160513,3165,102509),(30087,3081,102467),(30931,3078,102467),(30106,3085,102467),(30773,3090,102467),(30963,3080,102467),(134436,3390,102609),(134436,3392,102609),(134436,3393,102609),(126500,12,3),(409,32,7),(12022,424,46937),(3595,363,28720),(3595,364,28720),(3595,365,28720),(3595,366,28720),(3595,367,28720),(3595,369,28720),(3595,370,28720),(375,6,102485),(73754,2719,102322),(161948,2846,102396),(33770,2629,102268),(12022,424,46937),(32006,3199,102533),(6025,3296,102574),(37475,604,102192),(46640,600,102192),(83745,3333,102574),(83745,3329,102574),(83745,3335,102574),(50534,3053,102460),(114095,3105,102471),(1370,133,190),(2041,23,5),(163110,2859,102396),(162057,2848,102396),(6201,46,144),(14085,2928,102431),(23564,3389,102609),(134466,3389,102609),(3881,314,28682),(140595,3243,102553),(80758,3397,144),(30503,3082,102467),(20384,2775,102355),(96675,2725,102327),(45835,109,168),(63719,109,168),(87066,179,1483),(21283,179,1483),(117463,3105,102471),(94378,336,28703),(101404,340,28703),(105830,339,28703),(103523,339,28703),(96293,338,28703),(81285,3217,102540),(81285,3373,102540),(81285,3372,102540),(13533,3109,102472),(59946,2884,102409),(3098,147,199),(124437,304,28593),(37176,2884,102409),(123763,304,28593),(22405,2614,102263),(127325,2614,102263),(124626,2692,102306),(3098,3365,199),(10481,2575,102250),(10481,2574,102250),(10328,2574,102250),(10328,2575,102250),(4766,302,18549),(22248,2692,102306),(6975,309,28669),(2075,102,161),(105616,133,190),(4028,133,190),(3977,133,190),(41116,3005,102454),(5023,3005,102454),(101868,3235,102551),(114316,116,174),(185307,116,174),(37849,2886,102411),(22405,2615,102263),(46639,600,102192),(158787,604,102192),(8176,2969,102441),(8176,2970,102441),(8176,3314,102441),(191263,2969,102441),(159480,2940,102436),(191263,3314,102441),(131359,3314,102441),(131359,2969,102441),(131359,2970,102441),(191263,2970,102441),(131283,2827,102387),(152783,3234,102551),(10199,186,1505),(143873,3236,102551),(6501,308,28669),(140288,3252,102553),(72483,3250,102553),(102179,283,27899),(16181,2876,102401),(140923,2604,102261),(110477,2860,102397),(93146,2860,102397),(123716,2860,102397),(128427,2860,102397),(112999,2860,102397),(216536,2674,102292),(216206,2674,102292),(216161,2674,102292),(39153,2890,102415),(216206,2675,102292),(216536,2675,102292),(216161,2675,102292),(216161,2676,102292),(216536,2676,102292),(216206,2676,102292),(84999,3389,102609),(9366,162,102479),(90237,162,102479),]

    giorno_migrazione = datetime.date(2016, 1, 20)
    # da US a UU
    #pp = p.objects.using(db_alias).filter(email_contatto__exact='').exclude(utenza__email__isnull=True)
    #tot = pp.count()
    tot = 0
    print("  => 0020 deleghe da ripristinare come unita territoriale: %d" % (len(coppie),))
    for persona_vecchio_id, comitato_vecchio_id, locale_vecchio_id in coppie:

        try:
            d = Delega.objects.filter(
                Q(
                    fine__isnull=True
                ) | Q(fine__gte=giorno_migrazione),
                persona__vecchio_id=persona_vecchio_id,
                inizio__lte=giorno_migrazione,
                oggetto_id__in=Sede.objects.filter(estensione__in=['L'],
                                                    vecchio_id=locale_vecchio_id).values_list("id", flat=True),
                tipo="US",
            )
            for x in d:
                x.tipo = "UU"
                x.save()
                tot += 1

        except Sede.DoesNotExist:
            pass
        except Delega.DoesNotExist:
            pass


    print("  ==> 0020 ripristinate %d deleghe" % (tot,))

class Migration(migrations.Migration):

    dependencies = [
        ('anagrafica', '0018_aggiornamento_incarichi'),

    ]

    operations = [
        migrations.RunPython(forwards_func),
    ]
